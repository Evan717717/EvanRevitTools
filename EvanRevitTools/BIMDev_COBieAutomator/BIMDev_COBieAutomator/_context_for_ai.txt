=== ğŸ›‘ PROJECT CONTEXT & RULES (READ THIS FIRST) ===


# _AI_RULES.md

## 1. å°ˆæ¡ˆç›®æ¨™ (Objective)

**BIMDev_COBieAutomator** æ˜¯ä¸€å€‹å°ˆç‚º Revit é–‹ç™¼çš„è³‡æ–™èˆ‡åƒæ•¸è‡ªå‹•åŒ–ç®¡ç†å¤–æ›ï¼Œæ—¨åœ¨è§£æ±º BIM æ¨¡å‹èˆ‡ COBie (Construction Operations Building information exchange) è³‡æ–™æµä¹‹é–“çš„é›™å‘ç¶­è­·å•é¡Œã€‚

æ ¹æ“šç¨‹å¼ç¢¼é‚è¼¯ï¼Œå…¶æ ¸å¿ƒåŠŸèƒ½å®šç¾©å¦‚ä¸‹ï¼š

* 
**Excel è³‡æ–™æ³¨å…¥ (Data Injection)**ï¼šé€éè®€å–ç‰¹å®šæ ¼å¼çš„ Excel (Bè¡¨)ï¼Œæ¯”å°æ—ç¾¤èˆ‡é¡å‹åç¨±ï¼Œå°‡ COBie è³‡æ–™æ‰¹æ¬¡å¯«å…¥å°æ‡‰çš„ Revit å…ƒä»¶åƒæ•¸ä¸­ ã€‚


* 
**åƒæ•¸è‡ªå‹•åŒ–ç¶­è­· (Parameter Management)**ï¼šè®€å–å…±ç”¨åƒæ•¸æª” (.txt)ï¼Œæ”¯æ´æ‰¹æ¬¡å°‡åƒæ•¸ç¶å®šåˆ°æŒ‡å®šçš„æ¨¡å‹é¡åˆ¥ (Category)ï¼Œæˆ–å¾å°ˆæ¡ˆä¸­ç§»é™¤åƒæ•¸ ã€‚


* 
**è‡ªå‹•åŒ–æ‰¹æ¬¡è™•ç† (Batch Automation)**ï¼šå…·å‚™èƒŒæ™¯é–‹å•Ÿå¤šå€‹ Revit æª”æ¡ˆã€å»ºç«‹åƒæ•¸ã€æ³¨å…¥è³‡æ–™ã€ä¸¦è‡ªå‹•åˆ¤æ–·åŸ·è¡Œã€ŒåŒæ­¥å›ä¸­å¤®ã€æˆ–ã€Œå„²å­˜è¦†è“‹ã€çš„èƒ½åŠ› ã€‚



## 2. æŠ€è¡“å †ç–Š (Tech Stack)

* 
**Framework**ï¼š.NET Framework 4.8 (æ¨æ–·è‡ª `packages.config` çš„ `targetFramework="net48"`) ã€‚


* **Revit API**ï¼šç›¸å®¹ Revit 2021+ (åŸºæ–¼ .NET 4.8 éœ€æ±‚)ã€‚
* **UI æ¡†æ¶**ï¼šWPF (Windows Presentation Foundation) ä½¿ç”¨ XAML å®šç¾©ä»‹é¢ã€‚
* **ç¬¬ä¸‰æ–¹å¥—ä»¶**ï¼š
* 
**NPOI (2.5.6)**ï¼šç”¨æ–¼ç„¡é ˆå®‰è£ Office å³å¯è®€å–èˆ‡è§£æ Excel (.xlsx) æª”æ¡ˆ ã€‚


* 
**System.Memory / System.Buffers**ï¼šNPOI çš„ç›¸ä¾å¥—ä»¶ï¼Œç”¨æ–¼å„ªåŒ–è¨˜æ†¶é«”æ“ä½œ ã€‚





## 3. æ ¸å¿ƒæ¶æ§‹ (Architecture)

### Entry Point (é€²å…¥é»)

* **App.cs (`IExternalApplication`)**ï¼š
* è² è²¬æ‡‰ç”¨ç¨‹å¼ç”Ÿå‘½é€±æœŸç®¡ç†ã€‚
* åœ¨ `OnStartup` ä¸­å»ºç«‹åç‚º "BIM Development" çš„ Ribbon Tab å’Œ "COBie Tools" é¢æ¿ ã€‚


* è¨»å†Šå…©å€‹ä¸»è¦æŒ‰éˆ•ï¼š
1. 
**è³‡æ–™å°å…¥**ï¼šå°æ‡‰ `Command.cs` ã€‚


2. 
**å…±ç”¨åƒæ•¸ç¶­è­·**ï¼šå°æ‡‰ `CommandParameter.cs` ã€‚






* **Command.cs / CommandParameter.cs (`IExternalCommand`)**ï¼š
* ä½œç‚º Revit æŒ‡ä»¤çš„è§¸ç™¼å™¨ã€‚
* è² è²¬å–å¾— `UIApplication` æˆ– `UIDocument`ï¼Œä¸¦å¯¦ä¾‹åŒ–å°æ‡‰çš„ WPF è¦–çª— (`MainWindow` æˆ– `ParameterWindow`) ã€‚





### UI äº’å‹•èˆ‡åŸ·è¡Œç·’æ¨¡å‹

* **æ¨¡å¼ (Modality)**ï¼š
* æ¡ç”¨ **Modal (æ¨¡æ…‹)** æ¨¡å¼ã€‚è¦–çª—æ˜¯é€é `ShowDialog()` å‘¼å«çš„ ã€‚


* **æ¶æ§‹æ„ç¾©**ï¼šé€™æ„å‘³è‘—ç•¶è¦–çª—é–‹å•Ÿæ™‚ï¼ŒRevit çš„ä¸»è¦–çª—æœƒè¢«é–å®š (Freeze)ï¼Œä½† API çš„åŸ·è¡Œç·’ (Main Thread) ä»ç„¶ä¿æŒæ´»èºã€‚


* **è§¸ç™¼é‚è¼¯**ï¼š
* ç”±æ–¼è¦–çª—è™•æ–¼ Modal ç‹€æ…‹ï¼ŒUI äº‹ä»¶ (å¦‚ `BtnRun_Click`) ä¾ç„¶åœ¨ Revit çš„ä¸»åŸ·è¡Œç·’ä¸­é‹è¡Œã€‚å› æ­¤ç¨‹å¼ç¢¼ **ç›´æ¥å‘¼å«** Revit API (å¦‚ `RunCOBieInjection`)ï¼Œè€Œæœªä½¿ç”¨ `IExternalEventHandler` (External Event) ã€‚





### Transaction (äº‹å‹™è™•ç†)

* 
**å±¬æ€§è¨­å®š**ï¼šCommand é¡åˆ¥æ¨™è¨˜ç‚º `[Transaction(TransactionMode.Manual)]` ã€‚


* **äº‹å‹™ç¯„åœ**ï¼š
* äº‹å‹™ä¸¦éåœ¨ Command é–‹å§‹æ™‚å»ºç«‹ï¼Œè€Œæ˜¯åœ¨ **UI äº‹ä»¶å…§éƒ¨** å»ºç«‹ã€‚
* 
**å–®æ©Ÿæ¨¡å¼**ï¼šåœ¨ `BtnRun_Click` ä¸­ä½¿ç”¨ `using (Transaction t = new Transaction(_doc, "COBie å–®æ©Ÿå°å…¥"))` åŒ…è£¹æ“ä½œ ã€‚


* 
**æ‰¹æ¬¡æ¨¡å¼**ï¼šç¨‹å¼æœƒèƒŒæ™¯é–‹å•Ÿæ–‡ä»¶ (`bgDoc`)ï¼Œä¸¦ç‚ºè©²æ–‡ä»¶å»ºç«‹ç¨ç«‹çš„äº‹å‹™ `Transaction(bgDoc, "æ‰¹æ¬¡è‡ªå‹•åŒ–ä½œæ¥­")` ã€‚


* 
**åŒæ­¥æ©Ÿåˆ¶**ï¼šæ‰¹æ¬¡è™•ç†ä¸­åŒ…å«é€²éšé‚è¼¯ï¼Œè‹¥æª”æ¡ˆç‚ºå·¥ä½œå…±ç”¨ (Workshared)ï¼Œå‰‡åŸ·è¡Œ `SynchronizeWithCentral` ä¸¦é‡‹æ”¾æ¬Šé™ï¼›å¦å‰‡åŸ·è¡Œ `Save` èˆ‡ `Close` ã€‚





## 4. é–‹ç™¼è¦ç¯„ (Guidelines)

åŸºæ–¼ç›®å‰çš„ç¨‹å¼ç¢¼é¢¨æ ¼åˆ†æï¼Œæœªä¾†å”ä½œé–‹ç™¼è«‹éµå®ˆä»¥ä¸‹è¦ç¯„ï¼š

1. **UI èˆ‡é‚è¼¯åˆ†é›¢ (Separation of Concerns)**ï¼š
* *ç¾ç‹€*ï¼šç›®å‰çš„æ¥­å‹™é‚è¼¯ (å¦‚ Excel è§£æ `RunCOBieInjection`ã€åƒæ•¸å»ºç«‹ `RunBatchParameterCreation`) ç›´æ¥å¯«åœ¨ `.xaml.cs` (Code-behind) ä¸­ã€‚
* *è¦ç¯„*ï¼šæœªä¾†æ‡‰å°‡ Revit API æ“ä½œé‚è¼¯æå–è‡³ç¨ç«‹çš„ `Service` æˆ– `Manager` é¡åˆ¥ä¸­ (ä¾‹å¦‚ `COBieService.cs`, `ParameterManager.cs`)ã€‚UI åƒ…è² è²¬æ”¶é›†è¼¸å…¥èˆ‡é¡¯ç¤ºé€²åº¦ï¼Œä¸æ‡‰åŒ…å«è¤‡é›œçš„å¹¾ä½•é‹ç®—æˆ–æª”æ¡ˆè§£æä»£ç¢¼ã€‚


2. **éŒ¯èª¤è™•ç† (Error Handling)**ï¼š
* 
*ç¾ç‹€*ï¼šç¨‹å¼ç¢¼ä¸­å­˜åœ¨å¤šè™•ç©ºçš„ `catch { }` å€å¡Š (ä¾‹å¦‚ `GetCellValue` æˆ–è¿´åœˆä¸­çš„ `try-catch`)ï¼Œé€™æœƒåå™¬éŒ¯èª¤å°è‡´é™¤éŒ¯å›°é›£ ã€‚


* *è¦ç¯„*ï¼š**ç¦æ­¢**ä½¿ç”¨ç©ºçš„ Catch å€å¡Šã€‚å¿…é ˆè¨˜éŒ„éŒ¯èª¤æ—¥èªŒ (Log) æˆ–åœ¨ Debug æ¨¡å¼ä¸‹æ‹‹å‡ºä¾‹å¤–ã€‚ç‰¹åˆ¥æ˜¯åœ¨æ‰¹æ¬¡è™•ç†è¿´åœˆä¸­ï¼Œå–®ä¸€æª”æ¡ˆçš„å¤±æ•—ä¸æ‡‰å°è‡´æ•´å€‹ç¨‹åºå´©æ½°ï¼Œä½†å¿…é ˆå°‡å¤±æ•—åŸå› è¨˜éŒ„åœ¨ `StringBuilder` æ—¥èªŒä¸­ã€‚


3. **Excel è³‡æºç®¡ç† (Resource Management)**ï¼š
* *ç¾ç‹€*ï¼šé›–ç„¶ä½¿ç”¨äº† `using`ï¼Œä½†åœ¨æ‰¹æ¬¡è™•ç†å¤§é‡æª”æ¡ˆæ™‚ï¼Œéœ€ç‰¹åˆ¥æ³¨æ„ NPOI çš„è¨˜æ†¶é«”ä½”ç”¨ã€‚
* 
*è¦ç¯„*ï¼šè®€å– Excel æ™‚ï¼Œæ‡‰ç¢ºä¿ `FileStream` è¨­å®šç‚º `FileShare.ReadWrite` ä»¥é¿å…æª”æ¡ˆé–å®šè¡çª ã€‚è®€å–å®Œç•¢å¾Œæ‡‰ç«‹å³é‡‹æ”¾ `IWorkbook` ç‰©ä»¶ï¼Œå°‡è³‡æ–™è½‰æ›ç‚º POCO (Plain Old CLR Object) å‚³éçµ¦é‚è¼¯å±¤ï¼Œé¿å…é•·æ™‚é–“æŒæœ‰ Excel æª”æ¡ˆæ§é»ã€‚
=== END OF RULES ===


--- FILE: app.config ---
ï»¿<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <runtime>
    <assemblyBinding xmlns="urn:schemas-microsoft-com:asm.v1">
      <dependentAssembly>
        <assemblyIdentity name="System.Runtime.CompilerServices.Unsafe" publicKeyToken="b03f5f7f11d50a3a" culture="neutral" />
        <bindingRedirect oldVersion="0.0.0.0-6.0.0.0" newVersion="6.0.0.0" />
      </dependentAssembly>
      <dependentAssembly>
        <assemblyIdentity name="System.Numerics.Vectors" publicKeyToken="b03f5f7f11d50a3a" culture="neutral" />
        <bindingRedirect oldVersion="0.0.0.0-4.1.4.0" newVersion="4.1.4.0" />
      </dependentAssembly>
      <dependentAssembly>
        <assemblyIdentity name="System.Buffers" publicKeyToken="cc7b13ffcd2ddd51" culture="neutral" />
        <bindingRedirect oldVersion="0.0.0.0-4.0.3.0" newVersion="4.0.3.0" />
      </dependentAssembly>
      <dependentAssembly>
        <assemblyIdentity name="System.Memory" publicKeyToken="cc7b13ffcd2ddd51" culture="neutral" />
        <bindingRedirect oldVersion="0.0.0.0-4.0.1.2" newVersion="4.0.1.2" />
      </dependentAssembly>
      <dependentAssembly>
        <assemblyIdentity name="ICSharpCode.SharpZipLib" publicKeyToken="1b03e6acf1164f73" culture="neutral" />
        <bindingRedirect oldVersion="0.0.0.0-1.4.2.13" newVersion="1.4.2.13" />
      </dependentAssembly>
    </assemblyBinding>
  </runtime>
</configuration>
--- END OF FILE ---

--- FILE: App.cs ---
ï»¿using System;
using System.Collections.Generic;
using System.IO; // ç‚ºäº†è®€å–ä¸²æµ
using System.Reflection; // ç‚ºäº†è®€å–å…§åµŒè³‡æº & DLL è·¯å¾‘
using System.Windows.Media.Imaging; // ç‚ºäº†è½‰æ›æˆ Revit çœ‹å¾—æ‡‚çš„åœ–ç‰‡æ ¼å¼
using Autodesk.Revit.Attributes;
using Autodesk.Revit.DB;
using Autodesk.Revit.UI;

namespace BIMDev_COBieAutomator
{
    [Transaction(TransactionMode.Manual)]
    public class App : IExternalApplication
    {
        public Result OnStartup(UIControlledApplication application)
        {
            // 1. å»ºç«‹ Ribbon Tab (åˆ†é )
            string tabName = "BIM Development";
            try
            {
                application.CreateRibbonTab(tabName);
            }
            catch
            {
                // å¦‚æœåˆ†é å·²ç¶“å­˜åœ¨ (ä¾‹å¦‚è¢«å…¶ä»–å¤–æ›å»ºç«‹äº†)ï¼Œå°±å¿½ç•¥éŒ¯èª¤ç¹¼çºŒå¾€ä¸‹
            }

            // 2. å»ºç«‹ Ribbon Panel (é¢æ¿)
            RibbonPanel panel = null;
            // å˜—è©¦åœ¨è©²åˆ†é ä¸‹å»ºç«‹é¢æ¿ï¼Œå¦‚æœé‡åå¯èƒ½æœƒå¤±æ•—ï¼Œæ‰€ä»¥åšå€‹æª¢æŸ¥
            List<RibbonPanel> panels = application.GetRibbonPanels(tabName);
            foreach (RibbonPanel p in panels)
            {
                if (p.Name == "COBie Tools")
                {
                    panel = p;
                    break;
                }
            }
            // å¦‚æœæ²’æ‰¾åˆ°å°±æ–°å»ºä¸€å€‹
            if (panel == null)
            {
                panel = application.CreateRibbonPanel(tabName, "COBie Tools");
            }

            // 3. å–å¾—ç›®å‰é€™æ”¯ DLL çš„è·¯å¾‘
            string assemblyPath = Assembly.GetExecutingAssembly().Location;

            // =======================================================
            // â˜… æŒ‰éˆ• 1: è³‡æ–™å°å…¥ (å°æ‡‰ Command.cs)
            // =======================================================
            PushButtonData btnData1 = new PushButtonData(
                "BtnImportCOBie",       // æŒ‰éˆ•å…§éƒ¨åç¨± (å”¯ä¸€)
                "COBie\nè³‡æ–™å°å…¥",      // æŒ‰éˆ•é¡¯ç¤ºåç¨± (\n ä»£è¡¨æ›è¡Œ)
                assemblyPath,           // DLL è·¯å¾‘
                "BIMDev_COBieAutomator.Command" // å°æ‡‰çš„ C# é¡åˆ¥å…¨å (Namespace.Class)
            );
            btnData1.AvailabilityClassName = "BIMDev_COBieAutomator.CommandAvailability";
            btnData1.ToolTip = "è®€å–å·²é€²è¡ŒMappingä¹‹Excelè¡¨ä¸¦å¯«å…¥Revitå…ƒä»¶åƒæ•¸";

            // â˜… è¨­å®šåœ–ç¤º (è¨˜å¾—åœ–ç‰‡ Build Action è¦æ”¹ç‚º Embedded Resource)
            btnData1.LargeImage = GetEmbeddedImage("Import_32.png");


            // =======================================================
            // â˜… æŒ‰éˆ• 2: åƒæ•¸å»ºç«‹ (å°æ‡‰ CommandParameter.cs)
            // =======================================================
            PushButtonData btnData2 = new PushButtonData(
                "BtnCreateParam",
                "å…±ç”¨åƒæ•¸ç¶­è­·",
                assemblyPath,
                "BIMDev_COBieAutomator.CommandParameter"
            );
            btnData2.ToolTip = "è®€å–å…±ç”¨åƒæ•¸æª” (.txt) ä¸¦æ‰¹æ¬¡ç¶å®šã€æ–°å¢æˆ–ç§»é™¤æ¨¡å‹åƒæ•¸";

            // â˜… è¨­å®šåœ–ç¤º
            btnData2.LargeImage = GetEmbeddedImage("Param_32.png");

            // 4. å°‡æŒ‰éˆ•åŠ å…¥é¢æ¿
            panel.AddItem(btnData1);
            // panel.AddSeparator(); // è¦–éœ€æ±‚æ±ºå®šè¦ä¸è¦åˆ†éš”ç·šï¼Œç¾åœ¨æœ‰åœ–ç¤ºé€šå¸¸ä¸ç”¨åˆ†éš”ç·šä¹Ÿå¾ˆå¥½çœ‹
            panel.AddItem(btnData2);

            return Result.Succeeded;
        }

        public Result OnShutdown(UIControlledApplication application)
        {
            return Result.Succeeded;
        }

        // =======================================================
        // â˜… è¼”åŠ©æ–¹æ³•ï¼šå¾ DLL çš„åµŒå…¥è³‡æºä¸­è®€å–åœ–ç‰‡
        // =======================================================
        public BitmapImage GetEmbeddedImage(string name)
        {
            try
            {
                // 1. å–å¾—ç›®å‰çš„ Assembly (ä¹Ÿå°±æ˜¯é€™å€‹ DLL è‡ªå·±)
                Assembly assembly = Assembly.GetExecutingAssembly();

                // 2. çµ„åˆè³‡æºåç¨±
                // æ ¼å¼é€šå¸¸æ˜¯ï¼š[å°ˆæ¡ˆNamespace].[è³‡æ–™å¤¾åç¨±].[æª”å.å‰¯æª”å]
                // è«‹ç¢ºèªä½ çš„ Namespace æ˜¯ BIMDev_COBieAutomatorï¼Œä¸”è³‡æ–™å¤¾å« Resources
                string resourceName = $"BIMDev_COBieAutomator.Resources.{name}";

                using (Stream stream = assembly.GetManifestResourceStream(resourceName))
                {
                    if (stream == null) return null;

                    BitmapImage image = new BitmapImage();
                    image.BeginInit();
                    image.StreamSource = stream;
                    image.CacheOption = BitmapCacheOption.OnLoad;
                    image.EndInit();
                    return image;
                }
            }
            catch
            {
                return null;
            }
        }
    }
}
--- END OF FILE ---

--- FILE: Command.cs ---
ï»¿using System;
using System.Collections.Generic;
using System.Linq;
using Autodesk.Revit.DB;
using Autodesk.Revit.UI;
using Autodesk.Revit.Attributes;

namespace BIMDev_COBieAutomator
{
    [Transaction(TransactionMode.Manual)]
    public class Command : IExternalCommand
    {
        public Result Execute(
            ExternalCommandData commandData,
            ref string message,
            ElementSet elements)
        {
            // 1. å–å¾— UI æ‡‰ç”¨ç¨‹å¼
            UIApplication uiapp = commandData.Application;

            try
            {
                // å¯¦ä¾‹åŒ–è¦–çª—
                MainWindow myWindow = new MainWindow(uiapp);

                // â˜…â˜…â˜… é—œéµä¿®æ­£ï¼šæ”¹å› ShowDialog() â˜…â˜…â˜…
                //é€™æœƒè®“è¦–çª—ä¿æŒåœ¨ API çš„åŸ·è¡Œç’°å¢ƒå…§ï¼Œè§£æ±º "Starting a transaction..." çš„éŒ¯èª¤
                myWindow.ShowDialog();

                return Result.Succeeded;
            }
            catch (Exception ex)
            {
                message = ex.Message;
                return Result.Failed;
            }
        }
    }

    public class CommandAvailability : IExternalCommandAvailability
    {
        public bool IsCommandAvailable(UIApplication applicationData, CategorySet selectedCategories)
        {
            return true;
        }
    }
}
--- END OF FILE ---

--- FILE: CommandParameter.cs ---
ï»¿using System;
using Autodesk.Revit.DB;
using Autodesk.Revit.UI;
using Autodesk.Revit.Attributes;

namespace BIMDev_COBieAutomator
{
    [Transaction(TransactionMode.Manual)]
    public class CommandParameter : IExternalCommand
    {
        public Result Execute(
            ExternalCommandData commandData,
            ref string message,
            ElementSet elements)
        {
            // å–å¾— UIDocument
            UIDocument uidoc = commandData.Application.ActiveUIDocument;

            // æª¢æŸ¥æ˜¯å¦é–‹å•Ÿäº†æ–‡ä»¶
            if (uidoc == null)
            {
                TaskDialog.Show("éŒ¯èª¤", "è«‹å…ˆé–‹å•Ÿä¸€å€‹ Revit å°ˆæ¡ˆæ¨¡å‹ï¼");
                return Result.Cancelled;
            }

            // é–‹å•Ÿæˆ‘å€‘çš„æ–°è¦–çª— (ParameterWindow)
            // æ³¨æ„ï¼šæˆ‘å€‘é‚„æ²’å»ºç«‹é€™å€‹è¦–çª—ï¼Œç­‰ä¸€ä¸‹æ­¥é©Ÿ 2 æœƒåš
            ParameterWindow paramWin = new ParameterWindow(uidoc);
            paramWin.ShowDialog();

            return Result.Succeeded;
        }
    }
}
--- END OF FILE ---

--- FILE: MainWindow.xaml ---
ï»¿<Window x:Class="BIMDev_COBieAutomator.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="COBie è‡ªå‹•åŒ–å°å…¥å·¥å…· - BIM Development" 
        Height="550" Width="700"
        WindowStartupLocation="CenterScreen"
        ResizeMode="NoResize">

    <Grid Margin="10">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="2*"/>
            <ColumnDefinition Width="1.8*"/>
        </Grid.ColumnDefinitions>

        <GroupBox Header="1. é¸æ“‡ Excel ä¾†æº" Grid.Column="0" Margin="0,0,5,0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <Button Name="BtnSelectFolder" Content="ğŸ“‚ é¸æ“‡è³‡æ–™å¤¾..." Height="25" Margin="5" Click="BtnSelectFolder_Click" />

                <ListBox Name="ListExcelFiles" Grid.Row="1" Margin="5"/>

                <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="5">
                    <Button Content="å…¨é¸" Width="50" Margin="0,0,5,0" Click="BtnSelectAll_Click"/>
                    <Button Content="å…¨ä¸é¸" Width="50" Click="BtnUnselectAll_Click"/>
                </StackPanel>
            </Grid>
        </GroupBox>

        <Grid Grid.Column="1" Margin="5,0,0,0">
            <TabControl Name="MainTabControl">

                <TabItem Header="ğŸ‘¤ ç•¶å‰æ¨¡å‹">
                    <StackPanel Margin="5">
                        <GroupBox Header="ç›®æ¨™æ¨¡å‹è³‡è¨Š" Margin="0,0,0,10">
                            <StackPanel Margin="5">
                                <TextBlock Text="ç›®å‰é€£æ¥æ¨¡å‹ï¼š" FontWeight="Bold" Margin="0,0,0,5"/>
                                <TextBlock Name="TxtModelName" Text="å°šæœªè®€å–" TextWrapping="Wrap" Foreground="Blue" Margin="0,0,0,10"/>
                                <TextBlock Text="æ­¤æ¨¡å¼å°‡ç›´æ¥å°ç›®å‰é–‹å•Ÿçš„ Revit è¦–çª—é€²è¡Œä¿®æ”¹ã€‚" Foreground="Gray" FontSize="10" TextWrapping="Wrap"/>
                            </StackPanel>
                        </GroupBox>

                        <GroupBox Header="å¯«å…¥è¨­å®š">
                            <StackPanel Margin="5">
                                <RadioButton Name="RbOnlyFillBlank" Content="åƒ…å¯«å…¥ç©ºç™½åƒæ•¸ (ä¿ç•™æ—¢æœ‰å€¼)" IsChecked="True" Margin="0,5"/>
                                <RadioButton Name="RbForceOverwrite" Content="å¼·åˆ¶è¦†è“‹ç¾æœ‰å€¼" Margin="0,5"/>
                            </StackPanel>
                        </GroupBox>

                        <Button Name="BtnRun" Content="ğŸš€ åŸ·è¡Œå°å…¥ (ç•¶å‰æ¨¡å‹)" Height="40" Margin="0,20,0,0" Click="BtnRun_Click"/>
                    </StackPanel>
                </TabItem>

                <TabItem Header="ğŸ“š æ‰¹æ¬¡è™•ç†">
                    <Grid Margin="5">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <GroupBox Header="1. å‰ç½®ä½œæ¥­ï¼šå»ºç«‹åƒæ•¸ (é¸å¡«)" Grid.Row="0" Margin="0,0,0,5">
                            <StackPanel Margin="5">
                                <CheckBox Name="CbRunParamCreation" Content="åŸ·è¡Œå‰å…ˆå»ºç«‹ COBie åƒæ•¸" Margin="0,0,0,5" Checked="CbRunParamCreation_CheckedChanged" Unchecked="CbRunParamCreation_CheckedChanged"/>

                                <Grid Name="GridParamSettings" IsEnabled="False">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBox Name="TxtSharedParamPath_Batch" IsReadOnly="True" Height="23" Text="è«‹é¸æ“‡å…±ç”¨åƒæ•¸æª” (.txt)..." Foreground="Gray" VerticalContentAlignment="Center"/>
                                    <Button Name="BtnSelectSPFile" Content="ç€è¦½..." Grid.Column="1" Width="50" Margin="5,0,0,0" Click="BtnSelectSPFile_Click"/>
                                </Grid>

                                <StackPanel Name="PanelParamOpts" IsEnabled="False" Margin="0,5,0,0">
                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                                        <TextBlock Text="ç¶å®šå°è±¡ï¼š" VerticalAlignment="Center" Width="65"/>
                                        <ComboBox Name="CmbCategoryMode" Width="150" Height="22" SelectedIndex="0">
                                            <ComboBoxItem Content="MEP å¸¸ç”¨é¡åˆ¥"/>
                                            <ComboBoxItem Content="æ‰€æœ‰æ¨¡å‹é¡åˆ¥ (All)"/>
                                        </ComboBox>
                                    </StackPanel>

                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="åƒæ•¸ç¾¤çµ„ï¼š" VerticalAlignment="Center" Width="65"/>
                                        <ComboBox Name="CmbGroups_Batch" Width="100" Margin="0,0,10,0" Height="22"/>
                                        <CheckBox Name="CbVary_Batch" Content="Vary by Group" IsChecked="True" VerticalAlignment="Center"
                                                  ToolTip="æ•¸å€¼å¯éš¨ç¾¤çµ„å¯¦é«”è®ŠåŒ–"/>
                                    </StackPanel>
                                </StackPanel>
                            </StackPanel>
                        </GroupBox>

                        <GroupBox Header="2. é¸æ“‡ç›®æ¨™ Revit æ¨¡å‹è³‡æ–™å¤¾" Grid.Row="1">
                            <StackPanel Margin="5">
                                <Button Content="ğŸ“‚ ç€è¦½è³‡æ–™å¤¾..." Click="BtnSelectRvtFolder_Click" Margin="0,0,0,5"/>
                            </StackPanel>
                        </GroupBox>

                        <GroupBox Header="å¾…è™•ç†æ¨¡å‹æ¸…å–®" Grid.Row="2" Margin="0,5">
                            <ListBox Name="ListRvtFiles" Margin="2"/>
                        </GroupBox>

                        <StackPanel Grid.Row="3">
                            <TextBlock Text="âš ï¸ æ³¨æ„ï¼šç¨‹å¼å°‡åœ¨èƒŒæ™¯é–‹å•Ÿã€ä¿®æ”¹ä¸¦å„²å­˜æª”æ¡ˆã€‚" Foreground="Red" FontSize="10" Margin="0,5"/>
                            <Button Name="BtnBatchRun" Content="ğŸ“¦ åŸ·è¡Œæ‰¹æ¬¡å…¨è‡ªå‹•ä½œæ¥­" Height="40" Background="#FFF0F0" FontWeight="Bold" Click="BtnBatchRun_Click"/>
                        </StackPanel>
                    </Grid>
                </TabItem>
            </TabControl>
        </Grid>
    </Grid>
</Window>
--- END OF FILE ---

--- FILE: MainWindow.xaml.cs ---
ï»¿using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Media;
using Autodesk.Revit.UI;
using Autodesk.Revit.DB;
using WinForms = System.Windows.Forms;
using NPOI.SS.UserModel;
using NPOI.XSSF.UserModel;

namespace BIMDev_COBieAutomator
{
    public partial class MainWindow : Window
    {
        private UIApplication _uiapp;
        private UIDocument _uidoc;
        private Document _doc;

        // ç”¨ä¾†è¨˜æ†¶ä¸Šæ¬¡è·¯å¾‘çš„è®Šæ•¸
        private string _lastExcelPath = "";
        private string _lastRvtPath = "";
        private string _lastSPPath = "";

        public MainWindow(UIApplication uiapp)
        {
            InitializeComponent();

            _uiapp = uiapp;
            _uidoc = uiapp.ActiveUIDocument;

            if (_uidoc != null)
            {
                _doc = _uidoc.Document;
                TxtModelName.Text = _doc.Title;
                TxtModelName.Foreground = Brushes.Blue;
            }
            else
            {
                _doc = null;
                TxtModelName.Text = "(ç„¡é–‹å•Ÿå°ˆæ¡ˆ - åƒ…é™ä½¿ç”¨æ‰¹æ¬¡æ¨¡å¼)";
                TxtModelName.Foreground = Brushes.Gray;
                if (BtnRun != null) BtnRun.IsEnabled = false;
            }
        }

        // ============================================================
        // UI äº‹ä»¶å€ (å·¦å´ Excel) - å¼·åˆ¶éš”é›¢è·¯å¾‘
        // ============================================================
        private void BtnSelectFolder_Click(object sender, RoutedEventArgs e)
        {
            WinForms.OpenFileDialog dialog = new WinForms.OpenFileDialog();
            dialog.ValidateNames = false;
            dialog.CheckFileExists = false;
            dialog.CheckPathExists = true;
            dialog.FileName = "é¸æ“‡è³‡æ–™å¤¾";
            dialog.Title = "è«‹é¸æ“‡åŒ…å« B è¡¨ (Excel) çš„è³‡æ–™å¤¾";
            dialog.Filter = "è³‡æ–™å¤¾|*.folder";
            dialog.RestoreDirectory = true;

            // â˜… é‚è¼¯ä¿®æ­£ï¼šå¦‚æœæ²’æœ‰è¨˜æ†¶ï¼Œå°±å¼·åˆ¶å›æ¡Œé¢ï¼Œé¿å…è¢«ä¸Šä¸€å€‹æŒ‰éˆ•å½±éŸ¿
            if (!string.IsNullOrEmpty(_lastExcelPath) && Directory.Exists(_lastExcelPath))
            {
                dialog.InitialDirectory = _lastExcelPath;
            }
            else
            {
                dialog.InitialDirectory = Environment.GetFolderPath(Environment.SpecialFolder.Desktop);
            }

            if (dialog.ShowDialog() == WinForms.DialogResult.OK)
            {
                string selectedPath = Path.GetDirectoryName(dialog.FileName);
                _lastExcelPath = selectedPath; // å¯«å…¥è¨˜æ†¶

                if (!string.IsNullOrEmpty(selectedPath))
                {
                    string[] excelFiles = Directory.GetFiles(selectedPath, "*.xlsx");
                    ListExcelFiles.Items.Clear();
                    foreach (string file in excelFiles)
                    {
                        if (Path.GetFileName(file).StartsWith("~$")) continue;
                        CheckBox cb = new CheckBox { Content = Path.GetFileName(file), Tag = file, IsChecked = true, Margin = new Thickness(2) };
                        ListExcelFiles.Items.Add(cb);
                    }
                    if (ListExcelFiles.Items.Count == 0) MessageBox.Show("è©²è³‡æ–™å¤¾å…§æ²’æœ‰ Excel æª”æ¡ˆ");
                }
            }
        }

        private void BtnSelectAll_Click(object sender, RoutedEventArgs e) { foreach (CheckBox cb in ListExcelFiles.Items) cb.IsChecked = true; }
        private void BtnUnselectAll_Click(object sender, RoutedEventArgs e) { foreach (CheckBox cb in ListExcelFiles.Items) cb.IsChecked = false; }


        // ============================================================
        // UI äº‹ä»¶å€ (æ‰¹æ¬¡åƒæ•¸è¨­å®š) - å¼·åˆ¶éš”é›¢è·¯å¾‘
        // ============================================================
        private void CbRunParamCreation_CheckedChanged(object sender, RoutedEventArgs e)
        {
            bool enable = CbRunParamCreation.IsChecked == true;
            if (GridParamSettings != null) GridParamSettings.IsEnabled = enable;
            if (PanelParamOpts != null) PanelParamOpts.IsEnabled = enable;
        }

        private void BtnSelectSPFile_Click(object sender, RoutedEventArgs e)
        {
            WinForms.OpenFileDialog dlg = new WinForms.OpenFileDialog { Filter = "Shared Parameter (*.txt)|*.txt" };
            dlg.RestoreDirectory = true;

            // â˜… é‚è¼¯ä¿®æ­£ï¼šå¦‚æœæ²’æœ‰è¨˜æ†¶ï¼Œå°±å¼·åˆ¶å›æ¡Œé¢
            if (!string.IsNullOrEmpty(_lastSPPath) && Directory.Exists(_lastSPPath))
            {
                dlg.InitialDirectory = _lastSPPath;
            }
            else
            {
                dlg.InitialDirectory = Environment.GetFolderPath(Environment.SpecialFolder.Desktop);
            }

            if (dlg.ShowDialog() == WinForms.DialogResult.OK)
            {
                _lastSPPath = Path.GetDirectoryName(dlg.FileName); // å¯«å…¥è¨˜æ†¶

                TxtSharedParamPath_Batch.Text = dlg.FileName;
                TxtSharedParamPath_Batch.Foreground = Brushes.Black;

                try
                {
                    if (_doc != null)
                    {
                        _doc.Application.SharedParametersFilename = dlg.FileName;
                        DefinitionFile spFile = _doc.Application.OpenSharedParameterFile();
                        CmbGroups_Batch.Items.Clear();
                        foreach (DefinitionGroup g in spFile.Groups) CmbGroups_Batch.Items.Add(g.Name);
                    }
                    else
                    {
                        string[] lines = File.ReadAllLines(dlg.FileName);
                        CmbGroups_Batch.Items.Clear();
                        foreach (string line in lines)
                        {
                            if (line.StartsWith("GROUP") && !line.StartsWith("GROUP\tID"))
                            {
                                string[] parts = line.Split('\t');
                                if (parts.Length > 2) CmbGroups_Batch.Items.Add(parts[2]);
                            }
                        }
                    }

                    if (CmbGroups_Batch.Items.Contains("COBie")) CmbGroups_Batch.SelectedItem = "COBie";
                    else if (CmbGroups_Batch.Items.Count > 0) CmbGroups_Batch.SelectedIndex = 0;
                }
                catch { }
            }
        }

        private void BtnSelectRvtFolder_Click(object sender, RoutedEventArgs e)
        {
            WinForms.OpenFileDialog dialog = new WinForms.OpenFileDialog();
            dialog.ValidateNames = false;
            dialog.CheckFileExists = false;
            dialog.CheckPathExists = true;
            dialog.FileName = "é¸æ“‡è³‡æ–™å¤¾";
            dialog.Title = "è«‹é¸æ“‡åŒ…å« Revit æ¨¡å‹ (.rvt) çš„è³‡æ–™å¤¾";
            dialog.Filter = "è³‡æ–™å¤¾|*.folder";
            dialog.RestoreDirectory = true;

            // â˜… é‚è¼¯ä¿®æ­£ï¼šå¦‚æœæ²’æœ‰è¨˜æ†¶ï¼Œå°±å¼·åˆ¶å›æ¡Œé¢
            if (!string.IsNullOrEmpty(_lastRvtPath) && Directory.Exists(_lastRvtPath))
            {
                dialog.InitialDirectory = _lastRvtPath;
            }
            else
            {
                dialog.InitialDirectory = Environment.GetFolderPath(Environment.SpecialFolder.Desktop);
            }

            if (dialog.ShowDialog() == WinForms.DialogResult.OK)
            {
                string selectedPath = Path.GetDirectoryName(dialog.FileName);
                _lastRvtPath = selectedPath; // å¯«å…¥è¨˜æ†¶

                if (!string.IsNullOrEmpty(selectedPath))
                {
                    string[] files = Directory.GetFiles(selectedPath, "*.rvt");
                    ListRvtFiles.Items.Clear();
                    foreach (string f in files)
                    {
                        if (f.Contains(".00") && f.EndsWith(".rvt")) continue;
                        CheckBox cb = new CheckBox { Content = Path.GetFileName(f), Tag = f, IsChecked = true };
                        ListRvtFiles.Items.Add(cb);
                    }
                    if (ListRvtFiles.Items.Count == 0) MessageBox.Show("è©²è³‡æ–™å¤¾å…§æ²’æœ‰ Revit æ¨¡å‹");
                }
            }
        }


        // ============================================================
        // æ ¸å¿ƒåŸ·è¡Œå€ (ä»¥ä¸‹ä¿æŒä¸è®Š)
        // ============================================================

        private void BtnRun_Click(object sender, RoutedEventArgs e)
        {
            if (_doc == null) return;
            List<string> files = GetCheckedFiles(ListExcelFiles);
            if (files.Count == 0) return;

            using (Transaction t = new Transaction(_doc, "COBie å–®æ©Ÿå°å…¥"))
            {
                t.Start();
                string report = RunCOBieInjection(_doc, files, RbOnlyFillBlank.IsChecked == true, true);
                t.Commit();
                MessageBox.Show(report);
            }
        }

        // 2. æ‰¹æ¬¡åŸ·è¡Œ

        private void BtnBatchRun_Click(object sender, RoutedEventArgs e)
        {
            // 1. åŸºæœ¬æª¢æŸ¥
            List<string> xlsFiles = GetCheckedFiles(ListExcelFiles);
            List<string> rvtFiles = GetCheckedFiles(ListRvtFiles);
            if (xlsFiles.Count == 0 || rvtFiles.Count == 0) { MessageBox.Show("è«‹ç¢ºèª Excel èˆ‡ Revit æª”æ¡ˆçš†å·²é¸æ“‡ï¼"); return; }

            // 2. åƒæ•¸è®€å–
            bool doCreateParam = CbRunParamCreation.IsChecked == true;
            string spPath = TxtSharedParamPath_Batch.Text;
            string spGroup = CmbGroups_Batch.SelectedItem?.ToString();
            bool spVary = CbVary_Batch.IsChecked == true;
            bool bindToAll = (CmbCategoryMode.SelectedIndex == 1);

            // 3. é˜²å‘†æª¢æŸ¥
            if (doCreateParam && (string.IsNullOrEmpty(spPath) || File.Exists(spPath) == false))
            {
                MessageBox.Show("è«‹é¸æ“‡æœ‰æ•ˆçš„å…±ç”¨åƒæ•¸æª” (.txt)ï¼"); return;
            }

            Autodesk.Revit.ApplicationServices.Application app = _uiapp.Application;
            System.Text.StringBuilder batchLog = new System.Text.StringBuilder();
            batchLog.AppendLine($"ã€æ‰¹æ¬¡å…¨è‡ªå‹•ä½œæ¥­å ±å‘Š (åŒæ­¥æ¨¡å¼)ã€‘ {DateTime.Now}");

            foreach (string rvtPath in rvtFiles)
            {
                string rvtName = Path.GetFileName(rvtPath);
                batchLog.AppendLine($"\nğŸ“‚ è™•ç†æ¨¡å‹: {rvtName}");

                // å®šç¾©è‡¨æ™‚æœ¬æ©Ÿæª”è·¯å¾‘ (é¿å…ç›´æ¥é–‹ä¸­å¤®æª”é€ æˆé–å®šæˆ–è­¦å‘Š)
                string tempLocalPath = Path.Combine(Path.GetTempPath(), rvtName);

                try
                {
                    // ====================================================
                    // â˜… ç­–ç•¥ï¼šå»ºç«‹è‡¨æ™‚æœ¬æ©Ÿæª” -> ä¿®æ”¹ -> åŒæ­¥å›ä¸­å¤®
                    // ====================================================

                    // 1. è¤‡è£½æª”æ¡ˆåˆ° Temp è³‡æ–™å¤¾ (é€™å‹•ä½œç­‰æ–¼å»ºç«‹äº†æœ¬æ©Ÿæª”)
                    File.Copy(rvtPath, tempLocalPath, true);

                    // 2. æº–å‚™é–‹å•Ÿé¸é …
                    OpenOptions openOpts = new OpenOptions();
                    // é—œé–‰æ‰€æœ‰å·¥ä½œé›†ä»¥åŠ é€Ÿé–‹å•Ÿ (Optional)
                    openOpts.SetOpenWorksetsConfiguration(new WorksetConfiguration(WorksetConfigurationOption.CloseAllWorksets));

                    // â˜…â˜…â˜… ä¿®æ­£é»ï¼šå°‡å­—ä¸²è·¯å¾‘è½‰æ›ç‚º ModelPath (è§£æ±º CS1503 éŒ¯èª¤) â˜…â˜…â˜…
                    ModelPath modelPath = ModelPathUtils.ConvertUserVisiblePathToModelPath(tempLocalPath);

                    // ä½¿ç”¨ ModelPath é–‹å•Ÿæ¨¡å‹
                    Document bgDoc = app.OpenDocumentFile(modelPath, openOpts);

                    using (Transaction t = new Transaction(bgDoc, "æ‰¹æ¬¡è‡ªå‹•åŒ–ä½œæ¥­"))
                    {
                        t.Start();

                        // --- æ­¥é©Ÿ A: å»ºç«‹åƒæ•¸ ---
                        if (doCreateParam)
                        {
                            string paramLog = RunBatchParameterCreation(bgDoc, app, spPath, spGroup, spVary, bindToAll);
                            batchLog.AppendLine($"   âš™ï¸ åƒæ•¸æª¢æŸ¥/å»ºç«‹: {paramLog}");
                        }

                        // --- æ­¥é©Ÿ B: å°å…¥è³‡æ–™ ---
                        string dataLog = RunCOBieInjection(bgDoc, xlsFiles, RbOnlyFillBlank.IsChecked == true, true);
                        if (dataLog.Contains("åš´é‡éŒ¯èª¤")) batchLog.AppendLine("   âŒ è³‡æ–™å°å…¥å¤±æ•—");
                        else batchLog.AppendLine("   âœ… è³‡æ–™å°å…¥å®Œæˆ");

                        t.Commit();
                    }

                    // ====================================================
                    // â˜… é—œéµå‹•ä½œï¼šåŒæ­¥å›ä¸­å¤® (Synchronize)
                    // ====================================================
                    if (bgDoc.IsWorkshared)
                    {
                        // è¨­å®šåŒæ­¥é¸é …
                        SynchronizeWithCentralOptions syncOpts = new SynchronizeWithCentralOptions();
                        syncOpts.Compact = true; // åŸ·è¡Œå£“ç¸®

                        // è¨­å®šè¦é‡‹æ”¾çš„æ¬Šé™ (å…¨éƒ¨é‡‹æ”¾)
                        RelinquishOptions relinquishOpts = new RelinquishOptions(true);
                        relinquishOpts.CheckedOutElements = true;
                        relinquishOpts.StandardWorksets = true;
                        relinquishOpts.UserWorksets = true;
                        relinquishOpts.FamilyWorksets = true;
                        relinquishOpts.ViewWorksets = true;
                        syncOpts.SetRelinquishOptions(relinquishOpts);

                        // è¨­å®šåŒæ­¥æ™‚çš„è¨»è§£
                        TransactWithCentralOptions transOpts = new TransactWithCentralOptions();

                        // åŸ·è¡ŒåŒæ­¥
                        bgDoc.SynchronizeWithCentral(transOpts, syncOpts);
                        batchLog.AppendLine("   ğŸ”„ å·²åŒæ­¥å›ä¸­å¤®æª”æ¡ˆ (å«å£“ç¸®)");
                    }
                    else
                    {
                        // å¦‚æœä¸æ˜¯å·¥ä½œå…±ç”¨æª”ï¼Œå°±ç›´æ¥å­˜æª”è¦†è“‹å›åŸè·¯å¾‘
                        bgDoc.Close(false);
                        File.Copy(tempLocalPath, rvtPath, true);
                        batchLog.AppendLine("   ğŸ’¾ å–®æ©Ÿæª”å·²è¦†è“‹å„²å­˜");
                    }

                    // é—œé–‰ä¸¦åˆªé™¤è‡¨æ™‚æª”
                    if (bgDoc.IsValidObject) bgDoc.Close(false);
                    if (File.Exists(tempLocalPath)) File.Delete(tempLocalPath);
                }
                catch (Exception ex)
                {
                    batchLog.AppendLine($"   âŒ åš´é‡éŒ¯èª¤: {ex.Message}");
                    try { if (File.Exists(tempLocalPath)) File.Delete(tempLocalPath); } catch { }
                }
            }

            MessageBox.Show(batchLog.ToString());
        }

        private string RunCOBieInjection(Document targetDoc, List<string> excelFiles, bool onlyFillBlank, bool ignoreTempFiles)
        {
            System.Text.StringBuilder log = new System.Text.StringBuilder();
            int total = 0;

            try
            {
                foreach (string filePath in excelFiles)
                {
                    string fileName = Path.GetFileName(filePath);
                    if (ignoreTempFiles && fileName.StartsWith("~$")) continue;
                    BuiltInCategory cat = GetCategoryFromFilename(filePath);
                    if (cat == BuiltInCategory.INVALID) continue;

                    FilteredElementCollector col = new FilteredElementCollector(targetDoc);
                    IList<Element> elems = col.OfCategory(cat).WhereElementIsNotElementType().ToElements();
                    if (elems.Count == 0) continue;

                    using (FileStream fs = new FileStream(filePath, FileMode.Open, FileAccess.Read, FileShare.ReadWrite))
                    {
                        IWorkbook workbook = new XSSFWorkbook(fs);
                        ISheet sheet = workbook.GetSheetAt(0);
                        IRow header = sheet.GetRow(1);
                        if (header == null) continue;

                        Dictionary<string, int> map = new Dictionary<string, int>();
                        for (int i = 0; i < header.LastCellNum; i++)
                        {
                            string h = header.GetCell(i)?.ToString().Trim();
                            if (!string.IsNullOrEmpty(h) && h.StartsWith("Cobie_", StringComparison.OrdinalIgnoreCase))
                                map["COBie_" + h.Substring(6)] = i;
                        }
                        if (map.Count == 0) continue;

                        int count = 0;
                        for (int r = 3; r <= sheet.LastRowNum; r++)
                        {
                            IRow row = sheet.GetRow(r);
                            if (row == null) continue;
                            string fName = row.GetCell(0)?.ToString().Trim();
                            string tName = row.GetCell(1)?.ToString().Trim();
                            if (string.IsNullOrEmpty(fName)) continue;

                            foreach (Element el in elems)
                            {
                                Element type = targetDoc.GetElement(el.GetTypeId());
                                if (type.get_Parameter(BuiltInParameter.SYMBOL_FAMILY_NAME_PARAM).AsString().Equals(fName, StringComparison.OrdinalIgnoreCase) &&
                                    type.Name.Equals(tName, StringComparison.OrdinalIgnoreCase))
                                {
                                    foreach (var kvp in map)
                                    {
                                        string val = GetCellValue(row, kvp.Value);
                                        Parameter p = el.LookupParameter(kvp.Key);
                                        if (p != null && !p.IsReadOnly)
                                        {
                                            if (onlyFillBlank && p.HasValue && !string.IsNullOrEmpty(p.AsString())) continue;
                                            p.Set(string.IsNullOrEmpty(val) ? "â”€" : val);
                                            count++; total++;
                                        }
                                    }
                                }
                            }
                        }
                        log.AppendLine($"æ›´æ–° {fileName}: {count} ç­†");
                    }
                }
            }
            catch (Exception ex) { log.AppendLine("Error: " + ex.Message); }
            return log.ToString();
        }

        private string GetCellValue(IRow row, int cellIndex)
        {
            ICell cell = row.GetCell(cellIndex);
            if (cell == null) return "";

            if (cell.CellType == NPOI.SS.UserModel.CellType.Formula)
            {
                try { return cell.StringCellValue; }
                catch { return cell.NumericCellValue.ToString(); }
            }
            return cell.ToString().Trim();
        }

        private string RunBatchParameterCreation(Document doc, Autodesk.Revit.ApplicationServices.Application app, string txtPath, string groupName, bool isVary, bool bindToAll)
        {
            try
            {
                app.SharedParametersFilename = txtPath;
                DefinitionFile spFile = app.OpenSharedParameterFile();
                if (spFile == null) return "ç„¡æ³•è®€å–åƒæ•¸æª”";

                DefinitionGroup group = spFile.Groups.get_Item(groupName);
                if (group == null) return $"æ‰¾ä¸åˆ°ç¾¤çµ„ {groupName}";

                CategorySet catSet = app.Create.NewCategorySet();

                if (bindToAll)
                {
                    foreach (Category cat in doc.Settings.Categories)
                    {
                        if (cat.AllowsBoundParameters &&
                            (cat.CategoryType == CategoryType.Model) &&
                            cat.CanAddSubcategory)
                        {
                            catSet.Insert(cat);
                        }
                    }
                }
                else
                {
                    BuiltInCategory[] cats = new BuiltInCategory[] {
                        BuiltInCategory.OST_PipeAccessory, BuiltInCategory.OST_MechanicalEquipment,
                        BuiltInCategory.OST_ElectricalFixtures, BuiltInCategory.OST_PlumbingFixtures,
                        BuiltInCategory.OST_DuctAccessory, BuiltInCategory.OST_ElectricalEquipment,
                        BuiltInCategory.OST_CableTray, BuiltInCategory.OST_Conduit,
                        BuiltInCategory.OST_Sprinklers, BuiltInCategory.OST_LightingFixtures,
                        BuiltInCategory.OST_CommunicationDevices, BuiltInCategory.OST_FireAlarmDevices,
                        BuiltInCategory.OST_DataDevices, BuiltInCategory.OST_SecurityDevices,
                        BuiltInCategory.OST_Doors, BuiltInCategory.OST_Windows,
                        BuiltInCategory.OST_Walls, BuiltInCategory.OST_Floors
                    };
                    foreach (var bic in cats)
                    {
                        try { catSet.Insert(doc.Settings.Categories.get_Item(bic)); } catch { }
                    }
                }

                int count = 0;
                foreach (Definition def in group.Definitions)
                {
                    if (doc.ParameterBindings.Contains(def)) continue;

                    InstanceBinding binding = app.Create.NewInstanceBinding(catSet);
                    if (doc.ParameterBindings.Insert(def, binding, BuiltInParameterGroup.PG_DATA))
                    {
                        var map = doc.ParameterBindings;
                        var it = map.ForwardIterator();
                        it.Reset();
                        while (it.MoveNext())
                        {
                            if (it.Key.Name == def.Name)
                            {
                                if (it.Key is InternalDefinition intDef)
                                {
                                    try { intDef.SetAllowVaryBetweenGroups(doc, isVary); } catch { }
                                }
                                break;
                            }
                        }
                        count++;
                    }
                }
                return $"æ–°å¢ {count} å€‹åƒæ•¸";
            }
            catch (Exception ex)
            {
                return $"éŒ¯èª¤: {ex.Message}";
            }
        }

        private List<string> GetCheckedFiles(ListBox list)
        {
            List<string> res = new List<string>();
            foreach (CheckBox cb in list.Items)
                if (cb.IsChecked == true) res.Add(cb.Tag.ToString());
            return res;
        }

        private BuiltInCategory GetCategoryFromFilename(string filePath)
        {
            string fileName = System.IO.Path.GetFileNameWithoutExtension(filePath);
            string categoryName = "";
            if (fileName.Contains("-")) categoryName = fileName.Substring(fileName.LastIndexOf('-') + 1).Trim();

            switch (categoryName)
            {
                case "Pipe Accessories": return BuiltInCategory.OST_PipeAccessory;
                case "Plumbing Fixtures": return BuiltInCategory.OST_PlumbingFixtures;
                case "Mechanical Equipment": return BuiltInCategory.OST_MechanicalEquipment;
                case "Electrical Fixtures": return BuiltInCategory.OST_ElectricalFixtures;
                case "Electrical Equipment": return BuiltInCategory.OST_ElectricalEquipment;
                case "Duct Accessories": return BuiltInCategory.OST_DuctAccessory;
                case "Communication Devices": return BuiltInCategory.OST_CommunicationDevices;
                case "Conduit Fittings": return BuiltInCategory.OST_ConduitFitting;
                case "Data Devices": return BuiltInCategory.OST_DataDevices;
                case "Fire Alarm Devices": return BuiltInCategory.OST_FireAlarmDevices;
                case "Lighting Devices": return BuiltInCategory.OST_LightingDevices;
                case "Lighting Fixtures": return BuiltInCategory.OST_LightingFixtures;
                case "Pipe Fittings": return BuiltInCategory.OST_PipeFitting;
                case "Sprinklers": return BuiltInCategory.OST_Sprinklers;
                case "Air Terminals": return BuiltInCategory.OST_DuctTerminal;
                case "Telephone Devices": return BuiltInCategory.OST_TelephoneDevices;
                case "Security Devices": return BuiltInCategory.OST_SecurityDevices;
                default: return BuiltInCategory.INVALID;
            }
        }
    }
}
--- END OF FILE ---

--- FILE: packages.config ---
ï»¿<?xml version="1.0" encoding="utf-8"?>
<packages>
  <package id="BouncyCastle.Cryptography" version="2.4.0" targetFramework="net48" />
  <package id="Enums.NET" version="5.0.0" targetFramework="net48" />
  <package id="ExtendedNumerics.BigDecimal" version="2025.1001.2.129" targetFramework="net48" />
  <package id="MathNet.Numerics.Signed" version="5.0.0" targetFramework="net48" />
  <package id="Microsoft.IO.RecyclableMemoryStream" version="3.0.1" targetFramework="net48" />
  <package id="NPOI" version="2.5.6" targetFramework="net48" />
  <package id="NSax" version="1.0.2" targetFramework="net48" />
  <package id="Portable.BouncyCastle" version="1.8.9" targetFramework="net48" />
  <package id="SharpZipLib" version="1.4.2" targetFramework="net48" />
  <package id="SixLabors.Fonts" version="1.0.1" targetFramework="net48" />
  <package id="SixLabors.ImageSharp" version="2.1.11" targetFramework="net48" />
  <package id="System.Buffers" version="4.5.1" targetFramework="net48" />
  <package id="System.Memory" version="4.5.5" targetFramework="net48" />
  <package id="System.Numerics.Vectors" version="4.5.0" targetFramework="net48" />
  <package id="System.Runtime.CompilerServices.Unsafe" version="6.0.0" targetFramework="net48" />
  <package id="System.Security.Cryptography.Xml" version="8.0.2" targetFramework="net48" />
  <package id="System.Text.Encoding.CodePages" version="5.0.0" targetFramework="net48" />
  <package id="System.Threading.Tasks.Extensions" version="4.5.2" targetFramework="net48" />
  <package id="ZString" version="2.6.0" targetFramework="net48" />
</packages>
--- END OF FILE ---

--- FILE: ParameterWindow.xaml ---
ï»¿<Window x:Class="BIMDev_COBieAutomator.ParameterWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="COBie åƒæ•¸ç¶­è­·ç®¡ç†å“¡" Height="650" Width="550" 
        ResizeMode="CanResize" WindowStartupLocation="CenterScreen">

    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <TextBlock Text="âš™ï¸ å…±ç”¨åƒæ•¸ç¶­è­·ä¸­å¿ƒ" FontSize="18" FontWeight="Bold" Margin="0,0,0,10"/>

        <GroupBox Header="1. å…±ç”¨åƒæ•¸ä¾†æºè¨­å®š (.txt)" Grid.Row="1" Margin="0,0,0,10">
            <StackPanel Margin="5">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBox Name="TxtSharedParamPath" IsReadOnly="True" Height="25" VerticalContentAlignment="Center"/>
                    <Button Name="BtnSelectFile" Content="ç€è¦½..." Grid.Column="1" Width="60" Margin="5,0,0,0" Click="BtnSelectFile_Click"/>
                </Grid>

                <Grid Margin="0,10,0,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock Text="é¸æ“‡ç›®æ¨™ç¾¤çµ„ï¼š" VerticalAlignment="Center" Margin="0,0,5,0"/>
                    <ComboBox Name="CmbGroups" Grid.Column="1" Height="25" SelectionChanged="CmbGroups_SelectionChanged"/>
                </Grid>
                <TextBlock Text="â€» è«‹é¸æ“‡å¦‚ 'COBie' ç­‰ç¾¤çµ„ï¼Œåˆ‡æ›ç¾¤çµ„å°‡è‡ªå‹•é‡æ–°æ•´ç†ä¸‹æ–¹æ¸…å–®" Foreground="Gray" FontSize="10" Margin="0,5,0,0"/>
            </StackPanel>
        </GroupBox>

        <TabControl Name="MainTabControl" Grid.Row="2" Margin="0,0,0,10" SelectionChanged="MainTabControl_SelectionChanged">

            <TabItem Header="â• æ–°å¢åƒæ•¸" Name="TabAdd">
                <Grid Margin="5">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <GroupBox Header="é¸æ“‡è¦æ–°å¢çš„åƒæ•¸ (ç°è‰²ä»£è¡¨å·²å­˜åœ¨)" Grid.Row="0">
                        <ListBox Name="ListParamsToAdd" Margin="5" ScrollViewer.VerticalScrollBarVisibility="Auto"/>
                    </GroupBox>

                    <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,5">
                        <Button Content="å…¨é¸" Width="50" Click="BtnSelectAllParams_Click" Margin="0,0,5,0"/>
                        <Button Content="å…¨ä¸é¸" Width="50" Click="BtnUnselectAllParams_Click"/>
                    </StackPanel>

                    <GroupBox Header="ç¶å®šç›®æ¨™ Category" Grid.Row="2" Height="150" Margin="0,5">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <ListBox Name="ListCategories" Grid.Row="0" Margin="5"/>
                            <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Right" Margin="5">
                                <Button Content="å…¨é¸" Width="50" Click="BtnSelectAllCats_Click" Margin="0,0,5,0"/>
                                <Button Content="å…¨ä¸é¸" Width="50" Click="BtnUnselectAllCats_Click"/>
                            </StackPanel>
                        </Grid>
                    </GroupBox>

                    <CheckBox Name="CbVaryByGroup" Grid.Row="3" Content="æ•¸å€¼å¯éš¨ç¾¤çµ„å¯¦é«”è®ŠåŒ– (Vary by Group)" IsChecked="True" Margin="0,5,0,5"/>

                    <Button Name="BtnCreate" Content="ğŸš€ åŸ·è¡Œæ–°å¢" Grid.Row="4" Height="35" Background="#E0FFE0" FontWeight="Bold" Click="BtnCreate_Click"/>
                </Grid>
            </TabItem>

            <TabItem Header="ğŸ—‘ï¸ ç§»é™¤åƒæ•¸" Name="TabRemove">
                <Grid Margin="5">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <TextBlock Text="âš ï¸ æ³¨æ„ï¼šé€™å°‡å¾å°ˆæ¡ˆä¸­æ°¸ä¹…ç§»é™¤é¸å®šçš„åƒæ•¸ï¼Œç„¡éœ€ TXT æª”å³å¯æ“ä½œã€‚" Foreground="Red" Margin="0,0,0,5"/>

                    <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,5">
                        <TextBlock Text="åƒæ•¸åç¨±é—œéµå­—ï¼š" VerticalAlignment="Center"/>
                        <TextBox Name="TxtRemoveFilter" Text="COBie" Width="100" Margin="5,0,0,0" VerticalContentAlignment="Center"/>
                        <Button Content="ğŸ” æƒæå°ˆæ¡ˆ" Width="80" Margin="5,0,0,0" Click="BtnScanProject_Click"/>
                    </StackPanel>

                    <GroupBox Header="æœå°‹çµæœ (å­˜åœ¨æ–¼æœ¬å°ˆæ¡ˆçš„åƒæ•¸)" Grid.Row="2">
                        <ListBox Name="ListParamsToRemove" Margin="5">
                        </ListBox>
                    </GroupBox>

                    <StackPanel Grid.Row="3">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,5">
                            <Button Content="å…¨é¸" Width="50" Click="BtnSelectAllRemove_Click" Margin="0,0,5,0"/>
                            <Button Content="å…¨ä¸é¸" Width="50" Click="BtnUnselectAllRemove_Click"/>
                        </StackPanel>
                        <Button Name="BtnRemove" Content="ğŸ’£ åŸ·è¡Œç§»é™¤" Height="35" Background="#FFE0E0" FontWeight="Bold" Click="BtnRemove_Click"/>
                    </StackPanel>
                </Grid>
            </TabItem>

        </TabControl>
    </Grid>
</Window>
--- END OF FILE ---

--- FILE: ParameterWindow.xaml.cs ---
ï»¿using System;
using System.IO;
using System.Collections.Generic;
using System.Linq;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Media; // ç”¨ä¾†è¨­å®šç°è‰²å­—é«”
using Autodesk.Revit.UI;
using Autodesk.Revit.DB;
using WinForms = System.Windows.Forms;

namespace BIMDev_COBieAutomator
{
    public partial class ParameterWindow : Window
    {
        private UIDocument _uidoc;
        private Document _doc;
        private Autodesk.Revit.ApplicationServices.Application _app;

        public ParameterWindow(UIDocument uidoc)
        {
            InitializeComponent();
            _uidoc = uidoc;
            _doc = uidoc.Document;
            _app = _doc.Application;

            LoadAllRevitCategories();
        }

        // 1. è¼‰å…¥ Categories
        private void LoadAllRevitCategories()
        {
            ListCategories.Items.Clear();
            List<Category> allCats = new List<Category>();

            foreach (Category cat in _doc.Settings.Categories)
            {
                if (cat.AllowsBoundParameters)
                {
                    if (!string.IsNullOrEmpty(cat.Name)) allCats.Add(cat);
                }
            }

            var sortedCats = allCats.OrderBy(c => c.Name).ToList();

            foreach (Category cat in sortedCats)
            {
                CheckBox cb = new CheckBox();
                cb.Content = cat.Name;
                cb.Tag = cat;
                if (IsCommonMEPCategory(cat)) cb.IsChecked = true;
                ListCategories.Items.Add(cb);
            }
        }

        private bool IsCommonMEPCategory(Category cat)
        {
            BuiltInCategory bic = (BuiltInCategory)cat.Id.IntegerValue;
            return bic == BuiltInCategory.OST_PipeAccessory ||
                   bic == BuiltInCategory.OST_PipeFitting ||
                   bic == BuiltInCategory.OST_MechanicalEquipment ||
                   bic == BuiltInCategory.OST_ElectricalFixtures ||
                   bic == BuiltInCategory.OST_ElectricalEquipment ||
                   bic == BuiltInCategory.OST_PlumbingFixtures ||
                   bic == BuiltInCategory.OST_DuctAccessory ||
                   bic == BuiltInCategory.OST_DuctTerminal ||
                   bic == BuiltInCategory.OST_CableTray ||
                   bic == BuiltInCategory.OST_Conduit ||
                   bic == BuiltInCategory.OST_Sprinklers ||
                   bic == BuiltInCategory.OST_LightingFixtures;
        }

        // ============================================================
        // â˜… æ–°å¢ï¼šåˆ†é åˆ‡æ›èˆ‡æœå°‹äº‹ä»¶ (ä½œæ³• B æ ¸å¿ƒ)
        // ============================================================

        // ç•¶ä½¿ç”¨è€…åˆ‡æ›åˆ†é æ™‚è§¸ç™¼
        private void MainTabControl_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            // ç¢ºä¿æ˜¯ TabControl æœ¬èº«è§¸ç™¼çš„ï¼Œé¿å…è¢«å…§éƒ¨çš„ ListBox å¹²æ“¾
            if (e.Source is TabControl)
            {
                // å¦‚æœåˆ‡æ›åˆ°ã€Œç§»é™¤åƒæ•¸ã€åˆ†é  (TabRemove)ï¼Œè‡ªå‹•æƒæå°ˆæ¡ˆ
                if (TabRemove != null && TabRemove.IsSelected)
                {
                    ScanProjectParameters();
                }
            }
        }

        // æ‰‹å‹•é»æ“Šã€Œæƒæå°ˆæ¡ˆã€æŒ‰éˆ•
        private void BtnScanProject_Click(object sender, RoutedEventArgs e)
        {
            ScanProjectParameters();
        }

        // â˜… æ ¸å¿ƒé‚è¼¯ï¼šç›´æ¥æƒæå°ˆæ¡ˆåƒæ•¸ (ä¸éœ€è¦ TXT)
        private void ScanProjectParameters()
        {
            ListParamsToRemove.Items.Clear();
            string keyword = TxtRemoveFilter.Text.Trim(); // å–å¾—é—œéµå­—ï¼Œé è¨­ "COBie"

            // å–å¾—å°ˆæ¡ˆä¸­æ‰€æœ‰çš„åƒæ•¸ç¶å®š
            BindingMap map = _doc.ParameterBindings;
            DefinitionBindingMapIterator it = map.ForwardIterator();
            it.Reset();

            List<Definition> foundDefs = new List<Definition>();

            while (it.MoveNext())
            {
                Definition def = it.Key;

                // éæ¿¾é‚è¼¯ï¼š
                // 1. åå­—åŒ…å«é—œéµå­— (å¿½ç•¥å¤§å°å¯«)
                // 2. å¦‚æœæ²’è¼¸å…¥é—œéµå­—ï¼Œå°±åˆ—å‡ºå…¨éƒ¨ (ç”±ä½¿ç”¨è€…è‡ªè¡Œæ±ºå®š)
                if (!string.IsNullOrEmpty(keyword))
                {
                    if (def.Name.IndexOf(keyword, StringComparison.OrdinalIgnoreCase) >= 0)
                    {
                        foundDefs.Add(def);
                    }
                }
                else
                {
                    foundDefs.Add(def);
                }
            }

            // æ’åºä¸¦é¡¯ç¤º
            var sortedDefs = foundDefs.OrderBy(d => d.Name).ToList();

            foreach (Definition def in sortedDefs)
            {
                CheckBox cb = new CheckBox();
                cb.Content = def.Name;
                cb.Tag = def; // è— Definition ç‰©ä»¶ï¼Œä¹‹å¾Œåˆªé™¤è¦ç”¨
                cb.IsChecked = false; // é è¨­ä¸å‹¾é¸
                ListParamsToRemove.Items.Add(cb);
            }
        }

        // ============================================================
        // TXT æª”æ¡ˆè®€å–å€ (Tab 1 å°ˆç”¨)
        // ============================================================
        private void BtnSelectFile_Click(object sender, RoutedEventArgs e)
        {
            WinForms.OpenFileDialog openFileDialog = new WinForms.OpenFileDialog();
            openFileDialog.Filter = "Shared Parameter Files (*.txt)|*.txt";
            if (openFileDialog.ShowDialog() == WinForms.DialogResult.OK)
            {
                TxtSharedParamPath.Text = openFileDialog.FileName;
                LoadGroupsFromFile(openFileDialog.FileName);
            }
        }

        private void LoadGroupsFromFile(string path)
        {
            string originalPath = _app.SharedParametersFilename;
            try
            {
                _app.SharedParametersFilename = path;
                DefinitionFile spFile = _app.OpenSharedParameterFile();
                if (spFile != null)
                {
                    CmbGroups.Items.Clear();
                    foreach (DefinitionGroup group in spFile.Groups)
                    {
                        CmbGroups.Items.Add(group.Name);
                    }
                    if (CmbGroups.Items.Contains("COBie")) CmbGroups.SelectedItem = "COBie";
                    else if (CmbGroups.Items.Count > 0) CmbGroups.SelectedIndex = 0;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"è®€å–å¤±æ•—ï¼š{ex.Message}");
            }
            finally
            {
                // _app.SharedParametersFilename = originalPath;
            }
        }

        private void CmbGroups_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (CmbGroups.SelectedItem == null) return;
            string groupName = CmbGroups.SelectedItem.ToString();
            RefreshParameterLists(groupName);
        }

        // â˜… ä¿®æ”¹å¾Œçš„æ ¸å¿ƒé‚è¼¯ï¼šåªè² è²¬åˆ·æ–° Tab 1 (æ–°å¢æ¸…å–®)
        private void RefreshParameterLists(string groupName)
        {
            ListParamsToAdd.Items.Clear();
            // æ³¨æ„ï¼šé€™è£¡ä¸å†æ“ä½œ ListParamsToRemoveï¼Œå› ç‚ºé‚£æ˜¯ Tab 2 çš„å·¥ä½œ

            string spPath = TxtSharedParamPath.Text;
            if (string.IsNullOrEmpty(spPath)) return;

            try
            {
                _app.SharedParametersFilename = spPath;
                DefinitionFile spFile = _app.OpenSharedParameterFile();
                if (spFile == null) return;
                DefinitionGroup group = spFile.Groups.get_Item(groupName);
                if (group == null) return;

                foreach (Definition def in group.Definitions)
                {
                    bool existsInProject = _doc.ParameterBindings.Contains(def);

                    // --- è™•ç†ã€Œæ–°å¢æ¸…å–®ã€ ---
                    CheckBox cbAdd = new CheckBox();
                    cbAdd.Tag = def;

                    if (existsInProject)
                    {
                        // å·²å­˜åœ¨ï¼šè®Šç°ã€ä¸èƒ½å‹¾é¸
                        cbAdd.Content = $"{def.Name} (å·²å­˜åœ¨)";
                        cbAdd.Foreground = Brushes.Gray;
                        cbAdd.IsEnabled = false;
                        cbAdd.IsChecked = false;
                    }
                    else
                    {
                        // ä¸å­˜åœ¨ï¼šæ­£å¸¸é¡¯ç¤º
                        cbAdd.Content = def.Name;
                        cbAdd.Foreground = Brushes.Black;
                        cbAdd.IsEnabled = true;
                        cbAdd.IsChecked = true;
                    }
                    ListParamsToAdd.Items.Add(cbAdd);
                }
            }
            catch { }
        }

        // ============================================================
        // åŸ·è¡Œæ–°å¢
        // ============================================================
        private void BtnCreate_Click(object sender, RoutedEventArgs e)
        {
            CategorySet catSet = _app.Create.NewCategorySet();
            foreach (CheckBox cb in ListCategories.Items)
            {
                if (cb.IsChecked == true) catSet.Insert(cb.Tag as Category);
            }
            if (catSet.IsEmpty) { MessageBox.Show("è«‹è‡³å°‘å‹¾é¸ä¸€å€‹ Categoryï¼"); return; }

            List<Definition> defsToAdd = new List<Definition>();
            foreach (CheckBox cb in ListParamsToAdd.Items)
            {
                if (cb.IsEnabled && cb.IsChecked == true)
                {
                    defsToAdd.Add(cb.Tag as Definition);
                }
            }
            if (defsToAdd.Count == 0) { MessageBox.Show("è«‹é¸æ“‡è¦æ–°å¢çš„åƒæ•¸ï¼"); return; }

            bool isVary = CbVaryByGroup.IsChecked == true;

            using (Transaction t = new Transaction(_doc, "æ–°å¢åƒæ•¸"))
            {
                t.Start();
                int count = 0;
                try
                {
                    foreach (Definition def in defsToAdd)
                    {
                        if (_doc.ParameterBindings.Contains(def)) continue;

                        InstanceBinding binding = _app.Create.NewInstanceBinding(catSet);
                        if (_doc.ParameterBindings.Insert(def, binding, BuiltInParameterGroup.PG_DATA))
                        {
                            var map = _doc.ParameterBindings;
                            var it = map.ForwardIterator();
                            it.Reset();
                            while (it.MoveNext())
                            {
                                if (it.Key.Name == def.Name)
                                {
                                    if (it.Key is InternalDefinition intDef)
                                    {
                                        try { intDef.SetAllowVaryBetweenGroups(_doc, isVary); } catch { }
                                    }
                                    break;
                                }
                            }
                            count++;
                        }
                    }
                    t.Commit();
                    MessageBox.Show($"æˆåŠŸæ–°å¢ {count} å€‹åƒæ•¸ï¼");

                    // åŸ·è¡Œå®Œç•¢å¾Œï¼Œé‡æ–°æ•´ç† Tab 1
                    if (CmbGroups.SelectedItem != null)
                        RefreshParameterLists(CmbGroups.SelectedItem.ToString());
                }
                catch (Exception ex)
                {
                    t.RollBack();
                    MessageBox.Show($"éŒ¯èª¤ï¼š{ex.Message}");
                }
            }
        }

        // ============================================================
        // åŸ·è¡Œç§»é™¤ (ä¿®æ”¹ç‰ˆï¼šæ­é… ScanProjectParameters)
        // ============================================================
        private void BtnRemove_Click(object sender, RoutedEventArgs e)
        {
            List<Definition> defsToRemove = new List<Definition>();
            foreach (CheckBox cb in ListParamsToRemove.Items)
            {
                if (cb.IsChecked == true) defsToRemove.Add(cb.Tag as Definition);
            }

            if (defsToRemove.Count == 0) { MessageBox.Show("è«‹å‹¾é¸è¦ç§»é™¤çš„åƒæ•¸ï¼"); return; }

            if (MessageBox.Show($"ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™ {defsToRemove.Count} å€‹åƒæ•¸å—ï¼Ÿ\né€™å°‡æœƒæ¸…é™¤æ¨¡å‹ä¸­æ‰€æœ‰å…ƒä»¶ä¸Šçš„ç›¸é—œè³‡æ–™ï¼",
                "è­¦å‘Š", MessageBoxButton.YesNo, MessageBoxImage.Warning) != MessageBoxResult.Yes)
            {
                return;
            }

            using (Transaction t = new Transaction(_doc, "ç§»é™¤åƒæ•¸"))
            {
                t.Start();
                int count = 0;
                try
                {
                    foreach (Definition def in defsToRemove)
                    {
                        try
                        {
                            _doc.ParameterBindings.Remove(def);
                            count++;
                        }
                        catch { }
                    }
                    t.Commit();
                    MessageBox.Show($"æˆåŠŸç§»é™¤ {count} å€‹åƒæ•¸ï¼");

                    // åŸ·è¡Œå®Œç•¢å¾Œï¼Œé‡æ–°æƒæ Tab 2
                    ScanProjectParameters();

                    // å¦‚æœ Tab 1 ä¹Ÿæœ‰é¸ç¾¤çµ„ï¼Œé †ä¾¿åˆ·æ–°ä¸€ä¸‹ (è®“ç°è‰²è®Šå›é»‘è‰²)
                    if (CmbGroups.SelectedItem != null)
                        RefreshParameterLists(CmbGroups.SelectedItem.ToString());
                }
                catch (Exception ex)
                {
                    t.RollBack();
                    MessageBox.Show($"éŒ¯èª¤ï¼š{ex.Message}");
                }
            }
        }

        // ============================================================
        // å…¨é¸/å…¨ä¸é¸æŒ‰éˆ•äº‹ä»¶
        // ============================================================
        private void BtnSelectAllParams_Click(object sender, RoutedEventArgs e) { SetAllChecks(ListParamsToAdd, true); }
        private void BtnUnselectAllParams_Click(object sender, RoutedEventArgs e) { SetAllChecks(ListParamsToAdd, false); }

        private void BtnSelectAllCats_Click(object sender, RoutedEventArgs e) { SetAllChecks(ListCategories, true); }
        private void BtnUnselectAllCats_Click(object sender, RoutedEventArgs e) { SetAllChecks(ListCategories, false); }

        private void BtnSelectAllRemove_Click(object sender, RoutedEventArgs e) { SetAllChecks(ListParamsToRemove, true); }
        private void BtnUnselectAllRemove_Click(object sender, RoutedEventArgs e) { SetAllChecks(ListParamsToRemove, false); }

        private void SetAllChecks(ListBox list, bool check)
        {
            foreach (CheckBox cb in list.Items)
            {
                if (cb.IsEnabled) cb.IsChecked = check;
            }
        }
    }
}
--- END OF FILE ---
